{% extends "base.html" %}
{% block content %}
<div class="row g-4">
    <!-- POS / Cart Section -->
    <div class="col-lg-6">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-cart-plus"></i> Point of Sale (Cashier)</h5>
            </div>
            <div class="card-body">
                <form class="mb-3">
                    <div class="mb-3">
                        <label for="material-select" class="form-label fw-semibold">Material</label>
                        <select id="material-select" class="form-select">
                            <option value=""> Select material </option>
                            {% for m in materials %}
                            <option value="{{ m.id }}" data-unit="{{ m.unit }}" data-qty="{{ m.quantity }}"
                                data-price="{{ m.price_per_unit }}">
                                {{ m.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="qty" class="form-label fw-semibold">Quantity</label>
                            <input id="qty" type="number" class="form-control" min="1" value="1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="price" class="form-label fw-semibold">Price per Unit (₱)</label>
                            <input id="price" type="number" step="0.01" class="form-control" value="0">
                        </div>
                    </div>

                    <button id="add-to-cart" type="button" class="btn btn-primary w-100">
                        <i class="bi bi-bag-plus"></i> Add to Cart
                    </button>
                </form>

                <hr>

                <h6 class="fw-bold mb-3"><i class="bi bi-basket"></i> Cart</h6>
                <div class="table-responsive">
                    <table class="table table-sm align-middle" id="cart-table">
                        <thead class="table-light">
                            <tr>
                                <th>Material</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Subtotal</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="cart-body"></tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <h5 class="mb-0 fw-bold">Total: ₱ <span id="total">0.00</span></h5>
                    <button id="checkout" class="btn btn-success">
                        <i class="bi bi-cash-coin"></i> Checkout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory & Tips -->
    <div class="col-lg-6">
        <div class="card shadow-sm border-0 mb-3">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-box-seam"></i> Quick Inventory</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm align-middle" id="inventory-table">
                        <thead class="table-light">
                            <tr>
                                <th>Material</th>
                                <th>Qty</th>
                                <th>Unit</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for m in materials %}
                            <tr>
                                <td>{{ m.name }}</td>
                                <td>{{ m.quantity }}</td>
                                <td>{{ m.unit }}</td>
                                <td>
                                    {% if m.quantity <= m.reorder_point %} <span class="badge bg-danger">LOW</span>
                                        {% else %}
                                        <span class="badge bg-success">OK</span>
                                        {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Tips</h5>
            </div>
            <div class="card-body">
                <p class="mb-0">
                    Use the cart to add multiple items and click <strong>Checkout</strong>
                    to record sales and automatically deduct stock. Low-stock items will
                    appear in <strong>Notifications</strong>.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Checkout Success Modal -->
<div class="modal fade" id="checkoutSuccessModal" tabindex="-1" aria-labelledby="checkoutSuccessModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-success">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="checkoutSuccessModalLabel">
                    <i class="bi bi-check-circle-fill"></i> Checkout Successful
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Your checkout has been completed successfully.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-success" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- POS Script -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const materialSelect = document.getElementById("material-select");
        const priceInput = document.getElementById("price");
        const qtyInput = document.getElementById("qty");
        const cartBody = document.getElementById("cart-body");
        const totalSpan = document.getElementById("total");
        const cart = [];

        // Auto-fill price when material changes
        materialSelect.addEventListener("change", () => {
            const selected = materialSelect.options[materialSelect.selectedIndex];
            priceInput.value = selected.getAttribute("data-price") || 0;
        });

        // Add to cart
        document.getElementById("add-to-cart").addEventListener("click", () => {
            const selected = materialSelect.options[materialSelect.selectedIndex];
            const id = selected.value;
            const name = selected.textContent.trim();
            const price = parseFloat(priceInput.value);
            const qty = parseInt(qtyInput.value);

            if (!id) return alert("Please select a material.");
            if (qty <= 0) return alert("Quantity must be greater than 0.");

            const subtotal = qty * price;
            cart.push({ id, name, qty, price, subtotal });
            renderCart();
        });

        // Render cart
        function renderCart() {
            cartBody.innerHTML = "";
            let total = 0;

            cart.forEach((item, index) => {
                total += item.subtotal;
                cartBody.insertAdjacentHTML("beforeend", `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.qty}</td>
                        <td>₱${item.price.toFixed(2)}</td>
                        <td>₱${item.subtotal.toFixed(2)}</td>
                        <td><button class="btn btn-sm btn-outline-danger remove-item" data-index="${index}">
                            <i class="bi bi-x"></i>
                        </button></td>
                    </tr>
                `);
            });
            totalSpan.textContent = total.toFixed(2);
        }

        // Remove item
        cartBody.addEventListener("click", (e) => {
            if (e.target.closest(".remove-item")) {
                const index = e.target.closest(".remove-item").dataset.index;
                cart.splice(index, 1);
                renderCart();
            }
        });

        // Checkout with backend call
        document.getElementById("checkout").addEventListener("click", async () => {
            if (!cart.length) return alert("Cart is empty!");

            try {
                const response = await fetch("/checkout", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ cart })
                });

                if (!response.ok) throw new Error("Server error: " + response.status);

                const result = await response.json();

                if (result.success) {
                    // Show Bootstrap modal instead of alert
                    const modal = new bootstrap.Modal(document.getElementById("checkoutSuccessModal"));
                    modal.show();

                    cart.length = 0;
                    renderCart();
                    if (result.updated_inventory) {
                        updateInventoryTable(result.updated_inventory);
                    }
                } else {
                    alert("Error: " + (result.message || "Unknown error"));
                }
            } catch (err) {
                alert("Checkout failed: " + err.message);
            }
        });

        // Update Quick Inventory Table
        function updateInventoryTable(inventory) {
            const tbody = document.querySelector("#inventory-table tbody");
            tbody.innerHTML = "";
            inventory.forEach(m => {
                tbody.insertAdjacentHTML("beforeend", `
                    <tr>
                        <td>${m.name}</td>
                        <td>${m.quantity}</td>
                        <td>${m.unit}</td>
                        <td>
                            ${m.quantity <= m.reorder_point
                        ? '<span class="badge bg-danger">LOW</span>'
                        : '<span class="badge bg-success">OK</span>'}
                        </td>
                    </tr>
                `);
            });
        }
    });
</script>

{% endblock %}